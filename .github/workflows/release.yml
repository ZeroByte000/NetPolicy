name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: netpolicyd-linux-x86_64.tar.gz
            use_cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact: netpolicyd-linux-aarch64.tar.gz
            use_cross: true
          - os: macos-14
            target: x86_64-apple-darwin
            artifact: netpolicyd-macos-x86_64.tar.gz
            use_cross: false
          - os: macos-14
            target: aarch64-apple-darwin
            artifact: netpolicyd-macos-arm64.tar.gz
            use_cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: netpolicyd-windows-x86_64.zip
            use_cross: false
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            artifact: netpolicyd-windows-arm64.zip
            use_cross: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross
        run: cargo install cross --locked

      - name: Build (native)
        if: ${{ !matrix.use_cross }}
        run: cargo build --release --bin netpolicyd --target ${{ matrix.target }}

      - name: Build (cross)
        if: matrix.use_cross
        run: cross build --release --bin netpolicyd --target ${{ matrix.target }}

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          tar -czf ${{ matrix.artifact }} -C target/${{ matrix.target }}/release netpolicyd

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "target\\${{ matrix.target }}\\release\\netpolicyd.exe" -DestinationPath "${{ matrix.artifact }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: ${{ matrix.artifact }}

  android:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      XRAY_VERSION: "latest"
      NDK_VERSION: "26.1.10909125"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Prepare Android keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -z "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            echo "ANDROID_KEYSTORE_BASE64 is not set"
            exit 1
          fi
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/keystore.jks

      - uses: android-actions/setup-android@v3

      - uses: dtolnay/rust-toolchain@stable

      - name: Install NDK
        run: |
          sdkmanager "ndk;${NDK_VERSION}"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${NDK_VERSION}" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_HOME/ndk/${NDK_VERSION}" >> $GITHUB_ENV

      - name: Install Rust targets (Android)
        run: |
          rustup target add aarch64-linux-android

      - name: Build (Android)
        run: |
          TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          export CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER="$TOOLCHAIN/aarch64-linux-android21-clang"
          cargo build --release --bin netpolicyd --target aarch64-linux-android

      - name: Prepare Android assets
        run: |
          cp target/aarch64-linux-android/release/netpolicyd android/app/src/main/assets/netpolicyd-arm64

      - name: Download Xray binaries
        env:
          XRAY_REPOS: "XTLS/Xray-core"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          auth_header=()
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            auth_header=(-H "Authorization: Bearer ${GITHUB_TOKEN}")
          fi
          fetch_releases() {
            local repo="$1"
            if [ "${XRAY_VERSION}" = "latest" ]; then
              curl -fsSL "${auth_header[@]}" "https://api.github.com/repos/${repo}/releases?per_page=10"
              return
            fi
            if curl -fsSL "${auth_header[@]}" "https://api.github.com/repos/${repo}/releases/tags/v${XRAY_VERSION}"; then
              return
            fi
            curl -fsSL "${auth_header[@]}" "https://api.github.com/repos/${repo}/releases?per_page=10"
          }
          extract_urls() {
            python3 -c $'import json,sys\n\ndata=json.load(sys.stdin)\nreleases=data if isinstance(data,list) else [data]\narm64=\"\"\n\nfor rel in releases:\n    for asset in rel.get(\"assets\", []):\n        name=asset.get(\"name\", \"\")\n        url=asset.get(\"browser_download_url\", \"\")\n        if not url:\n            continue\n        if not name.startswith(\"Xray-android-arm64-v8a\"):\n            continue\n        if name.endswith(\".zip\") or name.endswith(\".tar.gz\") or name.endswith(\".tgz\"):\n            arm64=url\n            break\n    if arm64:\n        break\n\nprint(arm64)\n'
          }
          ARM64_URL=""
          for repo in ${XRAY_REPOS}; do
            if ! XRAY_JSON="$(fetch_releases "${repo}")"; then
              continue
            fi
            URLS="$(printf '%s' "${XRAY_JSON}" | extract_urls)"
            ARM64_URL="$(printf '%s' "${URLS}" | sed -n '1p')"
            if [ -n "${ARM64_URL}" ]; then
              break
            fi
          done
          if [ -z "$ARM64_URL" ]; then
            echo "Xray Android assets not found"
            exit 1
          fi
          curl -fL --retry 3 --retry-all-errors -o xray-arm64.pkg "$ARM64_URL"
          mkdir -p xray-arm64
          case "$ARM64_URL" in
            *.zip) unzip -q xray-arm64.pkg -d xray-arm64 ;;
            *.tar.gz|*.tgz) tar -xzf xray-arm64.pkg -C xray-arm64 ;;
            *) echo "Unknown archive for arm64: $ARM64_URL"; exit 1 ;;
          esac
          XRAY_BIN64="$(find xray-arm64 -type f -name xray | head -n1)"
          if [ -z "$XRAY_BIN64" ]; then
            echo "Xray binary not found in archives"
            exit 1
          fi
          cp "$XRAY_BIN64" android/app/src/main/assets/xray-arm64

      - name: Install Android SDK packages
        run: |
          sdkmanager "platforms;android-34" "build-tools;34.0.0"

      - name: Install Gradle
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.2.1-bin.zip
          unzip -q gradle-8.2.1-bin.zip -d $HOME/gradle
          echo "$HOME/gradle/gradle-8.2.1/bin" >> $GITHUB_PATH

      - name: Build APK
        env:
          ANDROID_KEYSTORE_PATH: ${{ github.workspace }}/android/keystore.jks
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: gradle -p android assembleRelease

      - name: Package
        run: |
          mkdir -p dist
          cp target/aarch64-linux-android/release/netpolicyd dist/netpolicyd-android-arm64
          tar -czf netpolicyd-android-arm64.tar.gz -C dist netpolicyd-android-arm64
          APK_PATH="$(find android/app/build/outputs/apk/release -name '*.apk' | head -n1)"
          if [ -z "$APK_PATH" ]; then
            echo "Release APK not found"
            exit 1
          fi
          cp "$APK_PATH" dist/netpolicyd-android.apk

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-android
          path: |
            netpolicyd-android-arm64.tar.gz
            dist/netpolicyd-android.apk

  openwrt:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - version: "24.10"
            target_path: "armsr/armv8"
            device: "hg680"
          - version: "24.10"
            target_path: "armsr/armv8"
            device: "hg680p"
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y build-essential unzip xz-utils wget rsync zstd

      - uses: dtolnay/rust-toolchain@stable

      - name: Download OpenWrt SDK
        run: |
          set -euo pipefail
          TARGET_PATH="${{ matrix.target_path }}"
          TARGET_TAG="${TARGET_PATH//\//-}"
          if [ "${{ matrix.version }}" = "snapshot" ]; then
            BASE_PREFIX="https://downloads.openwrt.org/snapshots/targets"
            OWRT_VERSION="snapshot"
            SDK_REGEX="openwrt-sdk-${TARGET_TAG}_gcc-.*_musl.Linux-x86_64.tar.(xz|zst)"
          else
            SERIES="${{ matrix.version }}"
            RELEASE_INDEX="https://downloads.openwrt.org/releases/"
            LATEST=$(curl -fSL --retry 3 --retry-all-errors "$RELEASE_INDEX" | grep -o "href=\\\"${SERIES}\\.[0-9]\\+/\\\"" | sed -E "s/.*${SERIES}\\.([0-9]+)\\/\"/\\1/" | sort -V | tail -n1)
            if [ -z "$LATEST" ]; then
              echo "No release found for series ${SERIES}"
              exit 1
            fi
            VERSION="${SERIES}.${LATEST}"
            BASE_PREFIX="https://downloads.openwrt.org/releases/${VERSION}/targets"
            OWRT_VERSION="${VERSION}"
            SDK_REGEX="openwrt-sdk-${VERSION}-${TARGET_TAG}_gcc-.*_musl.Linux-x86_64.tar.(xz|zst)"
          fi
          BASE_URL="${BASE_PREFIX}/${TARGET_PATH}/"
          SHA_URL="${BASE_URL}sha256sums"
          SHA_DATA="$(curl -fSL --retry 3 --retry-all-errors "$SHA_URL")"
          SDK_FILE="$(printf '%s' "${SHA_DATA}" | awk "/${SDK_REGEX}/ {print \$2; exit}")"
          if [ -z "${SDK_FILE}" ]; then
            echo "SDK file not found at ${BASE_URL}"
            exit 1
          fi
          SDK_FILE="${SDK_FILE#\*}"
          SDK_URL="${BASE_URL}${SDK_FILE}"
          echo "OWRT_VERSION=${OWRT_VERSION}" >> $GITHUB_ENV
          echo "OWRT_TARGET=${TARGET_TAG}" >> $GITHUB_ENV
          echo "OWRT_DEVICE=${{ matrix.device }}" >> $GITHUB_ENV
          curl -fL --retry 3 --retry-all-errors -o sdk.tar.pkg "$SDK_URL"
          mkdir sdk
          case "$SDK_URL" in
            *.tar.xz) tar -xJf sdk.tar.pkg -C sdk --strip-components=1 ;;
            *.tar.zst) tar --zstd -xf sdk.tar.pkg -C sdk --strip-components=1 ;;
            *) echo "Unknown SDK archive: $SDK_URL"; exit 1 ;;
          esac
      - name: Build netpolicyd binary (OpenWrt)
        run: |
          rustup target add aarch64-unknown-linux-musl
          TOOLCHAIN_DIR="$(find sdk/staging_dir -maxdepth 1 -type d -name 'toolchain-*' | head -n1)"
          if [ -z "${TOOLCHAIN_DIR}" ]; then
            echo "OpenWrt toolchain not found"
            exit 1
          fi
          export PATH="${TOOLCHAIN_DIR}/bin:${PATH}"
          export CC="aarch64-openwrt-linux-musl-gcc"
          export AR="aarch64-openwrt-linux-musl-ar"
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER="${CC}"
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_AR="${AR}"
          export RUSTFLAGS="-C target-feature=-crt-static"
          cargo build --release --bin netpolicyd --target aarch64-unknown-linux-musl
          cp target/aarch64-unknown-linux-musl/release/netpolicyd openwrt/package/netpolicyd/files/netpolicyd

      - name: Build netpolicyd for OpenWrt
        run: |
          cd sdk
          cp -r ../openwrt/package/netpolicyd package/
          cp -r ../openwrt/package/luci-app-netpolicyd package/
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make defconfig
          make package/netpolicyd/compile V=s
          make package/luci-app-netpolicyd/compile V=s

      - name: Collect artifacts
        run: |
          cd sdk
          mkdir -p ../dist
          find bin/packages -name "netpolicyd_*.ipk" -print0 | xargs -0 -I {} cp {} ../dist/
          find bin/packages -name "luci-app-netpolicyd_*.ipk" -print0 | xargs -0 -I {} cp {} ../dist/

      - name: Package
        run: |
          tar -czf netpolicyd-openwrt-${{ env.OWRT_VERSION }}-${{ env.OWRT_TARGET }}-${{ env.OWRT_DEVICE }}.tar.gz -C dist .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-openwrt-${{ env.OWRT_DEVICE }}
          path: netpolicyd-openwrt-${{ env.OWRT_VERSION }}-${{ env.OWRT_TARGET }}-${{ env.OWRT_DEVICE }}.tar.gz

  release:
    runs-on: ubuntu-latest
    needs: [build, android, openwrt]
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Flatten artifacts
        run: |
          mkdir -p upload
          find dist -type f -maxdepth 3 -exec mv {} upload/ \;
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: upload/*
