name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: netpolicyd-linux-x86_64.tar.gz
            use_cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact: netpolicyd-linux-aarch64.tar.gz
            use_cross: true
          - os: macos-14
            target: x86_64-apple-darwin
            artifact: netpolicyd-macos-x86_64.tar.gz
            use_cross: false
          - os: macos-14
            target: aarch64-apple-darwin
            artifact: netpolicyd-macos-arm64.tar.gz
            use_cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: netpolicyd-windows-x86_64.zip
            use_cross: false
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            artifact: netpolicyd-windows-arm64.zip
            use_cross: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross
        run: cargo install cross --locked

      - name: Build (native)
        if: ${{ !matrix.use_cross }}
        run: cargo build --release --bin netpolicyd --target ${{ matrix.target }}

      - name: Build (cross)
        if: matrix.use_cross
        run: cross build --release --bin netpolicyd --target ${{ matrix.target }}

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          tar -czf ${{ matrix.artifact }} -C target/${{ matrix.target }}/release netpolicyd

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "target\\${{ matrix.target }}\\release\\netpolicyd.exe" -DestinationPath "${{ matrix.artifact }}"

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ matrix.artifact }}

  android:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      XRAY_VERSION: "latest"
      NDK_VERSION: "26.1.10909125"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - uses: android-actions/setup-android@v3

      - uses: dtolnay/rust-toolchain@stable

      - name: Install NDK
        run: |
          sdkmanager "ndk;${NDK_VERSION}"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${NDK_VERSION}" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_HOME/ndk/${NDK_VERSION}" >> $GITHUB_ENV

      - name: Install Rust targets (Android)
        run: |
          rustup target add aarch64-linux-android armv7-linux-androideabi

      - name: Build (Android)
        run: |
          TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          export CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER="$TOOLCHAIN/aarch64-linux-android21-clang"
          export CARGO_TARGET_ARMV7_LINUX_ANDROIDEABI_LINKER="$TOOLCHAIN/armv7a-linux-androideabi21-clang"
          cargo build --release --bin netpolicyd --target aarch64-linux-android
          cargo build --release --bin netpolicyd --target armv7-linux-androideabi

      - name: Prepare Android assets
        run: |
          cp target/aarch64-linux-android/release/netpolicyd android/app/src/main/assets/netpolicyd-arm64
          cp target/armv7-linux-androideabi/release/netpolicyd android/app/src/main/assets/netpolicyd-armv7

      - name: Download Xray binaries
        env:
          XRAY_REPOS: "XTLS/Xray-core XTLS/Xray-android"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          auth_header=()
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            auth_header=(-H "Authorization: Bearer ${GITHUB_TOKEN}")
          fi
          fetch_json() {
            local repo="$1"
            if [ "${XRAY_VERSION}" = "latest" ]; then
              curl -fsSL "${auth_header[@]}" "https://api.github.com/repos/${repo}/releases/latest"
            else
              curl -fsSL "${auth_header[@]}" "https://api.github.com/repos/${repo}/releases/tags/v${XRAY_VERSION}"
            fi
          }
          extract_urls() {
            python3 - <<'PY'
            import json
            import re
            import sys

            data = json.loads(sys.stdin.read())
            assets = {a.get("name", ""): a.get("browser_download_url", "") for a in data.get("assets", [])}

            def find_url(patterns):
                for name, url in assets.items():
                    for pattern in patterns:
                        if re.search(pattern, name, re.IGNORECASE):
                            return url
                return ""

            arm64 = find_url([r'android.*arm64.*v8a.*\.zip$', r'android.*arm64.*\.zip$'])
            armv7 = find_url([r'android.*arm32.*v7a.*\.zip$', r'android.*armv7.*\.zip$'])
            print(arm64)
            print(armv7)
            PY
          }
          ARM64_URL=""
          ARMV7_URL=""
          for repo in ${XRAY_REPOS}; do
            if ! XRAY_JSON="$(fetch_json "${repo}")"; then
              continue
            fi
            URLS="$(printf '%s' "${XRAY_JSON}" | extract_urls)"
            ARM64_URL="$(printf '%s' "${URLS}" | sed -n '1p')"
            ARMV7_URL="$(printf '%s' "${URLS}" | sed -n '2p')"
            if [ -n "${ARM64_URL}" ] && [ -n "${ARMV7_URL}" ]; then
              break
            fi
          done
          if [ -z "$ARM64_URL" ] || [ -z "$ARMV7_URL" ]; then
            echo "Xray Android assets not found"
            exit 1
          fi
          curl -fL --retry 3 --retry-all-errors -o xray-arm64.zip "$ARM64_URL"
          curl -fL --retry 3 --retry-all-errors -o xray-armv7.zip "$ARMV7_URL"
          unzip -q xray-arm64.zip -d xray-arm64
          unzip -q xray-armv7.zip -d xray-armv7
          cp xray-arm64/xray android/app/src/main/assets/xray-arm64
          cp xray-armv7/xray android/app/src/main/assets/xray-armv7

      - name: Install Android SDK packages
        run: |
          sdkmanager "platforms;android-34" "build-tools;34.0.0"

      - name: Install Gradle
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.2.1-bin.zip
          unzip -q gradle-8.2.1-bin.zip -d $HOME/gradle
          echo "$HOME/gradle/gradle-8.2.1/bin" >> $GITHUB_PATH

      - name: Build APK
        run: gradle -p android assembleRelease

      - name: Package
        run: |
          mkdir -p dist
          cp target/aarch64-linux-android/release/netpolicyd dist/netpolicyd-android-arm64
          cp target/armv7-linux-androideabi/release/netpolicyd dist/netpolicyd-android-armv7
          tar -czf netpolicyd-android-arm64.tar.gz -C dist netpolicyd-android-arm64
          tar -czf netpolicyd-android-armv7.tar.gz -C dist netpolicyd-android-armv7
          cp android/app/build/outputs/apk/release/app-release.apk dist/netpolicyd-android.apk

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            netpolicyd-android-arm64.tar.gz
            netpolicyd-android-armv7.tar.gz
            dist/netpolicyd-android.apk

  openwrt:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        version: ["22.03", "23.05", "snapshot"]
        target: ["64"]
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y build-essential unzip xz-utils wget rsync

      - uses: dtolnay/rust-toolchain@stable

      - name: Install cross
        run: cargo install cross --locked

      - name: Build netpolicyd binary (OpenWrt)
        run: |
          cross build --release --bin netpolicyd --target aarch64-unknown-linux-musl
          cp target/aarch64-unknown-linux-musl/release/netpolicyd openwrt/package/netpolicyd/files/netpolicyd

      - name: Download OpenWrt SDK
        run: |
          set -euo pipefail
          if [ "${{ matrix.version }}" = "snapshot" ]; then
            BASE_PREFIX="https://downloads.openwrt.org/snapshots/targets"
            OWRT_VERSION="snapshot"
            CANDIDATES=(
              "armvirt/${{ matrix.target }}:openwrt-sdk-armvirt-${{ matrix.target }}_gcc-.*_musl.Linux-x86_64.tar.xz"
              "armsr/armv8:openwrt-sdk-armsr-armv8_gcc-.*_musl.Linux-x86_64.tar.xz"
            )
          else
            SERIES="${{ matrix.version }}"
            RELEASE_INDEX="https://downloads.openwrt.org/releases/"
            LATEST=$(curl -fSL --retry 3 --retry-all-errors "$RELEASE_INDEX" | grep -o "href=\\\"${SERIES}\\.[0-9]\\+/\\\"" | sed -E "s/.*${SERIES}\\.([0-9]+)\\/\"/\\1/" | sort -V | tail -n1)
            if [ -z "$LATEST" ]; then
              echo "No release found for series ${SERIES}"
              exit 1
            fi
            VERSION="${SERIES}.${LATEST}"
            BASE_PREFIX="https://downloads.openwrt.org/releases/${VERSION}/targets"
            OWRT_VERSION="${VERSION}"
            CANDIDATES=(
              "armvirt/${{ matrix.target }}:openwrt-sdk-${VERSION}-armvirt-${{ matrix.target }}_gcc-.*_musl.Linux-x86_64.tar.xz"
              "armsr/armv8:openwrt-sdk-${VERSION}-armsr-armv8_gcc-.*_musl.Linux-x86_64.tar.xz"
            )
          fi
          SDK_URL=""
          OWRT_TARGET=""
          for candidate in "${CANDIDATES[@]}"; do
            TARGET_PATH="${candidate%%:*}"
            SDK_REGEX="${candidate#*:}"
            BASE_URL="${BASE_PREFIX}/${TARGET_PATH}/"
            SHA_URL="${BASE_URL}sha256sums"
            if ! SHA_DATA="$(curl -fSL --retry 3 --retry-all-errors "$SHA_URL")"; then
              continue
            fi
            SDK_FILE="$(printf '%s' "${SHA_DATA}" | awk "/${SDK_REGEX}/ {print \$2; exit}")"
            if [ -n "${SDK_FILE}" ]; then
              SDK_FILE="${SDK_FILE#\*}"
              SDK_URL="${BASE_URL}${SDK_FILE}"
              OWRT_TARGET="${TARGET_PATH//\//-}"
              break
            fi
          done
          if [ -z "${SDK_URL}" ]; then
            echo "SDK file not found for ${OWRT_VERSION}"
            exit 1
          fi
          echo "OWRT_VERSION=${OWRT_VERSION}" >> $GITHUB_ENV
          echo "OWRT_TARGET=${OWRT_TARGET}" >> $GITHUB_ENV
          curl -fL --retry 3 --retry-all-errors -o sdk.tar.xz "$SDK_URL"
          mkdir sdk
          tar -xJf sdk.tar.xz -C sdk --strip-components=1

      - name: Build netpolicyd for OpenWrt
        run: |
          cd sdk
          cp -r ../openwrt/package/netpolicyd package/
          cp -r ../openwrt/package/luci-app-netpolicyd package/
          make defconfig
          make package/netpolicyd/compile V=s
          make package/luci-app-netpolicyd/compile V=s

      - name: Collect artifacts
        run: |
          cd sdk
          mkdir -p ../dist
          find bin/packages -name "netpolicyd_*.ipk" -exec cp {} ../dist/ \\;
          find bin/packages -name "luci-app-netpolicyd_*.ipk" -exec cp {} ../dist/ \\;

      - name: Package
        run: |
          tar -czf netpolicyd-openwrt-${{ env.OWRT_VERSION }}-${{ env.OWRT_TARGET }}.tar.gz -C dist .

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            netpolicyd-openwrt-${{ env.OWRT_VERSION }}-${{ env.OWRT_TARGET }}.tar.gz
