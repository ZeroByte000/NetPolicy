name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: netpolicyd-linux-x86_64.tar.gz
            use_cross: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact: netpolicyd-linux-aarch64.tar.gz
            use_cross: true
          - os: macos-12
            target: x86_64-apple-darwin
            artifact: netpolicyd-macos-x86_64.tar.gz
            use_cross: false
          - os: macos-14
            target: aarch64-apple-darwin
            artifact: netpolicyd-macos-arm64.tar.gz
            use_cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: netpolicyd-windows-x86_64.zip
            use_cross: false
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            artifact: netpolicyd-windows-arm64.zip
            use_cross: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use_cross
        run: cargo install cross --locked

      - name: Build (native)
        if: ${{ !matrix.use_cross }}
        run: cargo build --release --bin netpolicyd --target ${{ matrix.target }}

      - name: Build (cross)
        if: matrix.use_cross
        run: cross build --release --bin netpolicyd --target ${{ matrix.target }}

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          tar -czf ${{ matrix.artifact }} -C target/${{ matrix.target }}/release netpolicyd

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "target\\${{ matrix.target }}\\release\\netpolicyd.exe" -DestinationPath "${{ matrix.artifact }}"

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ matrix.artifact }}

  android:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      XRAY_VERSION: "1.8.24"
      NDK_VERSION: "26.1.10909125"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - uses: android-actions/setup-android@v3

      - uses: dtolnay/rust-toolchain@stable

      - name: Install NDK
        run: |
          sdkmanager "ndk;${NDK_VERSION}"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${NDK_VERSION}" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_HOME/ndk/${NDK_VERSION}" >> $GITHUB_ENV

      - name: Install Rust targets (Android)
        run: |
          rustup target add aarch64-linux-android armv7-linux-androideabi

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --locked

      - name: Build (Android)
        run: |
          cargo ndk -t arm64-v8a -t armeabi-v7a -o target/android build --release --bin netpolicyd

      - name: Prepare Android assets
        run: |
          cp target/android/arm64-v8a/release/netpolicyd android/app/src/main/assets/netpolicyd-arm64
          cp target/android/armeabi-v7a/release/netpolicyd android/app/src/main/assets/netpolicyd-armv7

      - name: Download Xray binaries
        run: |
          wget -q https://github.com/XTLS/Xray-core/releases/download/v${XRAY_VERSION}/Xray-android-arm64-v8a.zip -O xray-arm64.zip
          wget -q https://github.com/XTLS/Xray-core/releases/download/v${XRAY_VERSION}/Xray-android-arm32-v7a.zip -O xray-armv7.zip
          unzip -q xray-arm64.zip -d xray-arm64
          unzip -q xray-armv7.zip -d xray-armv7
          cp xray-arm64/xray android/app/src/main/assets/xray-arm64
          cp xray-armv7/xray android/app/src/main/assets/xray-armv7

      - name: Install Android SDK packages
        run: |
          sdkmanager "platforms;android-34" "build-tools;34.0.0"

      - name: Install Gradle
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.2.1-bin.zip
          unzip -q gradle-8.2.1-bin.zip -d $HOME/gradle
          echo "$HOME/gradle/gradle-8.2.1/bin" >> $GITHUB_PATH

      - name: Build APK
        run: gradle -p android assembleRelease

      - name: Package
        run: |
          mkdir -p dist
          cp target/aarch64-linux-android/release/netpolicyd dist/netpolicyd-android-arm64
          cp target/armv7-linux-androideabi/release/netpolicyd dist/netpolicyd-android-armv7
          tar -czf netpolicyd-android-arm64.tar.gz -C dist netpolicyd-android-arm64
          tar -czf netpolicyd-android-armv7.tar.gz -C dist netpolicyd-android-armv7
          cp android/app/build/outputs/apk/release/app-release.apk dist/netpolicyd-android.apk

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            netpolicyd-android-arm64.tar.gz
            netpolicyd-android-armv7.tar.gz
            dist/netpolicyd-android.apk

  openwrt:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        version: ["22.03.7", "23.05.4", "snapshot"]
        target: ["64"]
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y build-essential unzip xz-utils wget rsync

      - uses: dtolnay/rust-toolchain@stable

      - name: Install cross
        run: cargo install cross --locked

      - name: Build netpolicyd binary (OpenWrt)
        run: |
          cross build --release --bin netpolicyd --target aarch64-unknown-linux-musl
          cp target/aarch64-unknown-linux-musl/release/netpolicyd openwrt/package/netpolicyd/files/netpolicyd

      - name: Download OpenWrt SDK
        run: |
          if [ "${{ matrix.version }}" = "snapshot" ]; then
            BASE_URL="https://downloads.openwrt.org/snapshots/targets/armvirt/${{ matrix.target }}/"
            SDK_FILE=$(wget -qO- "$BASE_URL" | grep -o "openwrt-sdk-armvirt-${{ matrix.target }}_gcc-[0-9.]*_musl.Linux-x86_64.tar.xz" | head -n1)
            if [ -z "$SDK_FILE" ]; then
              echo "SDK file not found at $BASE_URL"
              exit 1
            fi
            SDK_URL="${BASE_URL}${SDK_FILE}"
          else
            BASE_URL="https://downloads.openwrt.org/releases/${{ matrix.version }}/targets/armvirt/${{ matrix.target }}/"
            SDK_FILE=$(wget -qO- "$BASE_URL" | grep -o "openwrt-sdk-${{ matrix.version }}-armvirt-${{ matrix.target }}_gcc-[0-9.]*_musl.Linux-x86_64.tar.xz" | head -n1)
            if [ -z "$SDK_FILE" ]; then
              echo "SDK file not found at $BASE_URL"
              exit 1
            fi
            SDK_URL="${BASE_URL}${SDK_FILE}"
          fi
          wget -qO sdk.tar.xz "$SDK_URL"
          mkdir sdk
          tar -xJf sdk.tar.xz -C sdk --strip-components=1

      - name: Build netpolicyd for OpenWrt
        run: |
          cd sdk
          cp -r ../openwrt/package/netpolicyd package/
          cp -r ../openwrt/package/luci-app-netpolicyd package/
          make defconfig
          make package/netpolicyd/compile V=s
          make package/luci-app-netpolicyd/compile V=s

      - name: Collect artifacts
        run: |
          cd sdk
          mkdir -p ../dist
          find bin/packages -name "netpolicyd_*.ipk" -exec cp {} ../dist/ \\;
          find bin/packages -name "luci-app-netpolicyd_*.ipk" -exec cp {} ../dist/ \\;

      - name: Package
        run: |
          tar -czf netpolicyd-openwrt-${{ matrix.version }}-armvirt-${{ matrix.target }}.tar.gz -C dist .

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            netpolicyd-openwrt-${{ matrix.version }}-armvirt-${{ matrix.target }}.tar.gz
